table_504_4 = {
    "A-1": {
        "NS": {
            "Type I": {"A": 5, "B": 3},
            "Type II": {"A": 3, "B": 2},
            "Type III": {"A": 3, "B": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2, "B": 1}
        },
        "S": {
            "Type I": {"A": 6, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        }
    },
    "A-2": {
        "NS": {
            "Type I": {"A": 11, "B": 3},
            "Type II": {"A": 3, "B": 2},
            "Type III": {"A": 3, "B": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2, "B": 1}
        },
        "S": {
            "Type I": {"A": 12, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        }
    },
    "A-3": {
        "NS": {
            "Type I": {"A": 11, "B": 3},
            "Type II": {"A": 3, "B": 2},
            "Type III": {"A": 3, "B": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2, "B": 1}
        },
        "S": {
            "Type I": {"A": 12, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        }
    },
    "A-4": {
        "NS": {
            "Type I": {"A": 11, "B": 3},
            "Type II": {"A": 3, "B": 2},
            "Type III": {"A": 3, "B": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2, "B": 1}
        },
        "S": {
            "Type I": {"A": 12, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        }
    },
    "A-5": {
        "NS": {"Type I": {"A": "UL"}},
        "S": {"Type I": {"A": "UL"}}
    },
    "B": {
        "NS": {
            "Type I": {"A": 11, "B": 5},
            "Type II": {"A": 5, "B": 3},
            "Type III": {"A": 5, "B": 3},
            "Type IV": {"HT": 5},
            "Type V": {"A": 3, "B": 2}
        },
        "S": {
            "Type I": {"A": 12, "B": 6},
            "Type II": {"A": 6, "B": 4},
            "Type III": {"A": 6, "B": 4},
            "Type IV": {"HT": 6},
            "Type V": {"A": 4, "B": 3}
        }
    },
    "E": {
        "NS": {
            "Type I": {"A": 5, "B": 3},
            "Type II": {"A": 3, "B": 2},
            "Type III": {"A": 3, "B": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2, "B": 1}
        },
        "S": {
            "Type I": {"A": 6, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 2, "B": 2}
        }
    },
    "F-1": {
        "NS": {
            "Type I": {"A": 11, "B": 4},
            "Type II": {"A": 2, "B": 2},
            "Type III": {"A": 3, "B": 2},
            "Type IV": {"HT": 2},
            "Type V": {"A": 1, "B": 1}
        },
        "S": {
            "Type I": {"A": 12, "B": 5},
            "Type II": {"A": 3, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2, "B": 2}
        }
    },
    "F-2": {
        "NS": {
            "Type I": {"A": 11, "B": 5},
            "Type II": {"A": 3, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        },
        "S": {
            "Type I": {"A": 12, "B": 6},
            "Type II": {"A": 4, "B": 4},
            "Type III": {"A": 5, "B": 4},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4, "B": 3}
        }
    },
    "H-1": {
        "NS": {"Type I": {"A": 1}},
        "S": {"Type I": {"A": "NP"}}
    },
    "H-2": {
        "NS": {
            "Type I": {"A": 3},
            "Type II": {"A": 2},
            "Type III": {"A": 1},
            "Type IV": {"HT": 2},
            "Type V": {"A": 1}
        },
        "S": {"Type I": {"A": "NP"}}
    },
    "H-3": {
        "NS": {
            "Type I": {"A": 6},
            "Type II": {"A": 4},
            "Type III": {"A": 2},
            "Type IV": {"HT": 4},
            "Type V": {"A": 2}
        },
        "S": {"Type I": {"A": "NP"}}
    },
    "H-4": {
        "NS": {
            "Type I": {"A": 7},
            "Type II": {"A": 5},
            "Type III": {"A": 3},
            "Type IV": {"HT": 5},
            "Type V": {"A": 3}
        },
        "S": {
            "Type I": {"A": 8},
            "Type II": {"A": 6},
            "Type III": {"A": 4},
            "Type IV": {"HT": 6},
            "Type V": {"A": 4}
        }
    },
    "H-5": {
        "NS": {
            "Type I": {"A": 4},
            "Type II": {"A": 4},
            "Type III": {"A": 3},
            "Type IV": {"HT": 3},
            "Type V": {"A": 3}
        },
        "S": {"Type I": {"A": "NP"}}
    },
    "I-1 Condition 1": {
        "NS": {
            "Type I": {"A": 9, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        },
        "S": {
            "Type I": {"A": 10, "B": 5},
            "Type II": {"A": 5, "B": 4},
            "Type III": {"A": 5, "B": 4},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4, "B": 3}
        }
    },
    "I-1 Condition 2": {
        "NS": {
            "Type I": {"A": 9, "B": 4},
            "Type II": {"A": 4, "B": 3},
            "Type III": {"A": 4, "B": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3, "B": 2}
        },
        "S": {"Type I": {"A": 10}}
    },
    "I-2": {
        "NS": {
            "Type I": {"A": 4},
            "Type II": {"A": 2},
            "Type III": {"A": 1},
            "Type IV": {"HT": "NP"},
            "Type V": {"A": 1}
        },
        "S": {"Type I": {"A": 5}}
    },
    "I-3": {
        "NS": {
            "Type I": {"A": 4},
            "Type II": {"A": 2},
            "Type III": {"A": 1},
            "Type IV": {"HT": 2},
            "Type V": {"A": 2}
        },
        "S": {
            "Type I": {"A": 5},
            "Type II": {"A": 3},
            "Type III": {"A": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 3}
        }
    },
    "I-4": {
        "NS": {
            "Type I": {"A": 5},
            "Type II": {"A": 3},
            "Type III": {"A": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 1}
        },
        "S": {
            "Type I": {"A": 6},
            "Type II": {"A": 4},
            "Type III": {"A": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 2}
        }
    },
    "M": {
        "NS": {
            "Type I": {"A": 11},
            "Type II": {"A": 4},
            "Type III": {"A": 2},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3}
        },
        "S": {
            "Type I": {"A": 12},
            "Type II": {"A": 5},
            "Type III": {"A": 3},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4}
        }
    },
    "R-1": {
        "NS": {
            "Type I": {"A": 11, "B": 4},
            "Type II": {"A": 4},
            "Type III": {"A": 4},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3}
        },
        "S": {
            "Type I": {"A": 12, "B": 5},
            "Type II": {"A": 5},
            "Type III": {"A": 5},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4, "B": 3}
        }
    },
    "R-2": {
        "NS": {
            "Type I": {"A": 11, "B": 4},
            "Type II": {"A": 4},
            "Type III": {"A": 4},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3}
        },
        "S": {
            "Type I": {"A": 12, "B": 5},
            "Type II": {"A": 5},
            "Type III": {"A": 5},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4}
        }
    },
    "R-3": {
        "NS": {
            "Type I": {"A": 11, "B": 4},
            "Type II": {"A": 4},
            "Type III": {"A": 4},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3}
        },
        "S": {
            "Type I": {"A": 12, "B": 5},
            "Type II": {"A": 5},
            "Type III": {"A": 5},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4}
        }
    },
    "R-4": {
        "NS": {
            "Type I": {"A": 11, "B": 4},
            "Type II": {"A": 4},
            "Type III": {"A": 4},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3}
        },
        "S": {
            "Type I": {"A": 12, "B": 5},
            "Type II": {"A": 5},
            "Type III": {"A": 5},
            "Type IV": {"HT": 5},
            "Type V": {"A": 4}
        }
    },
    "S-1": {
        "NS": {
            "Type I": {"A": 11},
            "Type II": {"A": 4},
            "Type III": {"A": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 1}
        },
        "S": {
            "Type I": {"A": 12},
            "Type II": {"A": 5},
            "Type III": {"A": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 2}
        }
    },
    "S-2": {
        "NS": {
            "Type I": {"A": 11, "B": 5},
            "Type II": {"A": 5},
            "Type III": {"A": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 2}
        },
        "S": {
            "Type I": {"A": 12, "B": 6},
            "Type II": {"A": 6},
            "Type III": {"A": 4},
            "Type IV": {"HT": 5},
            "Type V": {"A": 3}
        }
    },
    "U": {
        "NS": {
            "Type I": {"A": 5},
            "Type II": {"A": 4},
            "Type III": {"A": 2},
            "Type IV": {"HT": 3},
            "Type V": {"A": 2}
        },
        "S": {
            "Type I": {"A": 6},
            "Type II": {"A": 5},
            "Type III": {"A": 3},
            "Type IV": {"HT": 4},
            "Type V": {"A": 3}
        }
    }
}

import rdflib
# Load RDF graph
rdf_graph = rdflib.Graph()
rdf_graph.parse("LBD files\smartReview\outputHotel Compliant Revit 2023 Advanced with Spaces.ifc.ttl", format="ttl")

# Getting Storey information 
with open("SPARQL\storeyRule.sparql", "r") as file:
    sparql_query = file.read()

results = rdf_graph.query(sparql_query)

# Process the results to create the BIM model and print the output
for result in results:
    construction_type = result.constructionType.toPython()
    occupancy_group = result.occupancyGroup.toPython()
    sprinkler_type = result.sprinklerType.toPython() if result.sprinklerType else "none"
    storey_num = result.storeyNumValue.toPython()

    # Splitting the construction type and subtype 
    if "-" in construction_type:
        main_construction_type, subtype = construction_type.rsplit("-", 1)
    else:
        main_construction_type = construction_type
        subtype = ""

    bim_model = {
        "occupancy": occupancy_group,
        "sprinkler_system": "S" if sprinkler_type != "none" else "NS",
        "construction_type": main_construction_type.strip(),  # "Type V"
        "subtype": subtype.strip(),  # "A"
        "num_stories": int(storey_num)
    }

    # Find the height limit for the given model
    storey_limit = None
    for occupancy in table_504_4:
        if bim_model["occupancy"] in occupancy.split(", "):
            try:
                storey_limit = table_504_4[occupancy][bim_model["sprinkler_system"]][bim_model["construction_type"]][bim_model["subtype"]]
            except KeyError:
                storey_limit = None
            break

    # Check if the height is within the allowed limit
    if storey_limit:
        if bim_model["num_stories"] <= storey_limit:
            result_message = f"The building number of stories ({bim_model['num_stories']}) does not exceed the maximum allowed number of stories of ({storey_limit}) as specified in Table 504.4 for:\n" \
                             f"• Occupancy - {bim_model['occupancy']},\n" \
                             f"• Construction Type - {bim_model['construction_type']},\n" \
                             f"• Subtype - {bim_model['subtype']},\n" \
                             f"• Sprinkler System - {bim_model['sprinkler_system']}."
        else:
            result_message = f"The building number of stories ({bim_model['num_stories']}) exceeds the limit allowed number of stories of ({storey_limit}) as specified in Table 504.3 for:\n" \
                             f"• Occupancy - {bim_model['occupancy']},\n" \
                             f"• Construction Type - {bim_model['construction_type']},\n" \
                             f"• Subtype - {bim_model['subtype']},\n" \
                             f"• Sprinkler System - {bim_model['sprinkler_system']}."
    else:
        result_message = "Storey limit not found for the given BIM model.\n" \
                         f"• Occupancy - {bim_model['occupancy']}\n" \
                         f"• Sprinkler System - {bim_model['sprinkler_system']}\n" \
                         f"• Construction Type - {bim_model['construction_type']}\n" \
                         f"• Subtype - {bim_model['subtype']}"

    print(result_message)
